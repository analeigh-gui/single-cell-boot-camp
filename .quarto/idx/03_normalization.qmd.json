{"title":"Chapter 3 Normalization and PCA","markdown":{"yaml":{"title":"Chapter 3 Normalization and PCA","execute":{"warning":false,"message":false}},"headingText":"libraries for this chapter","containsRefs":false,"markdown":"\n\n```{r}\nlibrary(tidyverse)\nlibrary(Seurat)\nlibrary(data.table)\nlibrary(celldex)\nlibrary(SingleR)\nlibrary(ExperimentHub)\n```\n\n# Load RData\n\nLoad the RData which contain all files from previous chapter.\n\n```{r}\nload(\"data/intermediate_data/chapter2.RData\")\n```\n\n# \n\n# 1. Normalization\n\nWe will perform normalization on UMI counts using `LogNormalize`.\n\n`LogNormalize` divides the UMI counts of a gene in a cell into the total UMI counts in that cell. After division, we take the natural log.\n\n```{r}\nfiltered.rna <- NormalizeData(filtered.rna, \n                              normalization.method = \"LogNormalize\")\n```\n\n::: callout-important\n## Question\n\nWhere are the normalized counts stored?\n:::\n\n::: {.callout-tip collapse=\"T\"}\n## Answer\n\nThe normalizaed counts are stored in the slot `RNA`.\n\n```{r}\nfiltered.rna@assays[[\"RNA\"]]@data[1:5, 1:5]\n```\n:::\n\n# 2. Evaluating effects of mitochondrial percentage\n\nThe unwanted variation, such as the difference in mitochondrial percentage, could affect the downstream analysis.\n\nFor example, we don't want the cells clustered based on the difference in mitochondrial percentage.\n\nLet's first look at if the mitochondrial percentage introduces unwanted variation. We take the normalized counts and see if we have unwanted variation from the mitochondrial percentage.\n\n1.  The mitochondrial percentage is a series of numbers. We can turn the mitochondrial percentage variable into a categorical variable based on quartiles.\n\n```{r}\nsummary(filtered.rna$percent.mt)\n```\n\nBelow 1st quartile: Low.\n\nBetween 1st and Median: Median.\n\nBetween Median and 3rd quartile: Median high.\n\nbeyond 3rd quartile (15.4158%): High.\n\nNext, we create a new variable based on the cutoff.\n\n```{r}\nfiltered.rna$quartile.mt <- cut(filtered.rna$percent.mt, \n                                breaks=c(-Inf, 10.1004, 12.4155, 15.1489, Inf),\n                                labels=c(\"Low\",\"Medium\",\"Medium high\", \"High\"))\n```\n\nWe want to check whether the mitochondrial percentage is a source of variation using PCA. We plot the first two principal components to visualize the data.\n\n```{r}\n# Identify the most variable genes\nfiltered.rna <- FindVariableFeatures(filtered.rna,\n                                           selection.method = \"vst\",\n                                           nfeatures = 2000, \n                                           verbose = FALSE)\n\t\t     \n# Scale the data\nfiltered.rna <- ScaleData(filtered.rna, features = rownames(filtered.rna))\n\n# perform PCA\nfiltered.rna <- RunPCA(filtered.rna)\n\n# Plot pc1 and pc2\nDimPlot(filtered.rna,\n        reduction = \"pca\",\n        group.by= \"quartile.mt\",\n        split.by = \"quartile.mt\")\n```\n\nBased on the above plot, we can see a different scatter pattern in cells with \"Low\" mitochondrial percentage.\n\nWe observe that the lobe of cells in the left middle side of the plot is in the category \"Low\". For all other levels of mitochondrial percentage, we see a more even distribution of cells across the PCA plot.\n\n::: callout-tip\nOftentimes, it is helpful to regress out variation due to mitochondrial percentage. However, if the differences in mitochondrial gene expression represent a biological phenomenon that might help to distinguish cell clusters, then we do not regress it out.\n:::\n\n::: callout-tip\nCell cycle is another common variation. For instructions, please refer to <https://satijalab.org/seurat/articles/cell_cycle_vignette.html>\n:::\n\nTo regress out the effect mitochondrial percentage, add the argument `vars.to.regress = \"percent.mt\"` to the `ScaleData`.\n\n```{r}\n# Scale the data\nfiltered.rna <- ScaleData(filtered.rna, \n                                features = rownames(filtered.rna), \n                                vars.to.regress = \"percent.mt\")\n\n# perform PCA\nfiltered.rna <- RunPCA(filtered.rna)\n```\n\n# 3. Save\n\nSave the files into RData for documentation.\n\n```{r}\n# save(filtered.rna, expMat, file = \"data/intermediate_data/chapter3.RData\")\n```\n","srcMarkdownNoYaml":"\n\n```{r}\n# libraries for this chapter\nlibrary(tidyverse)\nlibrary(Seurat)\nlibrary(data.table)\nlibrary(celldex)\nlibrary(SingleR)\nlibrary(ExperimentHub)\n```\n\n# Load RData\n\nLoad the RData which contain all files from previous chapter.\n\n```{r}\nload(\"data/intermediate_data/chapter2.RData\")\n```\n\n# \n\n# 1. Normalization\n\nWe will perform normalization on UMI counts using `LogNormalize`.\n\n`LogNormalize` divides the UMI counts of a gene in a cell into the total UMI counts in that cell. After division, we take the natural log.\n\n```{r}\nfiltered.rna <- NormalizeData(filtered.rna, \n                              normalization.method = \"LogNormalize\")\n```\n\n::: callout-important\n## Question\n\nWhere are the normalized counts stored?\n:::\n\n::: {.callout-tip collapse=\"T\"}\n## Answer\n\nThe normalizaed counts are stored in the slot `RNA`.\n\n```{r}\nfiltered.rna@assays[[\"RNA\"]]@data[1:5, 1:5]\n```\n:::\n\n# 2. Evaluating effects of mitochondrial percentage\n\nThe unwanted variation, such as the difference in mitochondrial percentage, could affect the downstream analysis.\n\nFor example, we don't want the cells clustered based on the difference in mitochondrial percentage.\n\nLet's first look at if the mitochondrial percentage introduces unwanted variation. We take the normalized counts and see if we have unwanted variation from the mitochondrial percentage.\n\n1.  The mitochondrial percentage is a series of numbers. We can turn the mitochondrial percentage variable into a categorical variable based on quartiles.\n\n```{r}\nsummary(filtered.rna$percent.mt)\n```\n\nBelow 1st quartile: Low.\n\nBetween 1st and Median: Median.\n\nBetween Median and 3rd quartile: Median high.\n\nbeyond 3rd quartile (15.4158%): High.\n\nNext, we create a new variable based on the cutoff.\n\n```{r}\nfiltered.rna$quartile.mt <- cut(filtered.rna$percent.mt, \n                                breaks=c(-Inf, 10.1004, 12.4155, 15.1489, Inf),\n                                labels=c(\"Low\",\"Medium\",\"Medium high\", \"High\"))\n```\n\nWe want to check whether the mitochondrial percentage is a source of variation using PCA. We plot the first two principal components to visualize the data.\n\n```{r}\n# Identify the most variable genes\nfiltered.rna <- FindVariableFeatures(filtered.rna,\n                                           selection.method = \"vst\",\n                                           nfeatures = 2000, \n                                           verbose = FALSE)\n\t\t     \n# Scale the data\nfiltered.rna <- ScaleData(filtered.rna, features = rownames(filtered.rna))\n\n# perform PCA\nfiltered.rna <- RunPCA(filtered.rna)\n\n# Plot pc1 and pc2\nDimPlot(filtered.rna,\n        reduction = \"pca\",\n        group.by= \"quartile.mt\",\n        split.by = \"quartile.mt\")\n```\n\nBased on the above plot, we can see a different scatter pattern in cells with \"Low\" mitochondrial percentage.\n\nWe observe that the lobe of cells in the left middle side of the plot is in the category \"Low\". For all other levels of mitochondrial percentage, we see a more even distribution of cells across the PCA plot.\n\n::: callout-tip\nOftentimes, it is helpful to regress out variation due to mitochondrial percentage. However, if the differences in mitochondrial gene expression represent a biological phenomenon that might help to distinguish cell clusters, then we do not regress it out.\n:::\n\n::: callout-tip\nCell cycle is another common variation. For instructions, please refer to <https://satijalab.org/seurat/articles/cell_cycle_vignette.html>\n:::\n\nTo regress out the effect mitochondrial percentage, add the argument `vars.to.regress = \"percent.mt\"` to the `ScaleData`.\n\n```{r}\n# Scale the data\nfiltered.rna <- ScaleData(filtered.rna, \n                                features = rownames(filtered.rna), \n                                vars.to.regress = \"percent.mt\")\n\n# perform PCA\nfiltered.rna <- RunPCA(filtered.rna)\n```\n\n# 3. Save\n\nSave the files into RData for documentation.\n\n```{r}\n# save(filtered.rna, expMat, file = \"data/intermediate_data/chapter3.RData\")\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":true,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"tidy":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"03_normalization.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.340","theme":"cosmo","title":"Chapter 3 Normalization and PCA"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}