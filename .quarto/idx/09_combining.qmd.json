{"title":"Chapter 9 Combine scRNAseq and AbSeq","markdown":{"yaml":{"title":"Chapter 9 Combine scRNAseq and AbSeq","execute":{"warning":false,"message":false}},"headingText":"libraries for this chapter","containsRefs":false,"markdown":"\n\n```{r}\nlibrary(tidyverse)\nlibrary(Seurat)\nlibrary(data.table)\nlibrary(celldex)\nlibrary(SingleR)\nlibrary(ExperimentHub)\n```\n\n# Load RData\n\nLoad the RData which contains all files from the previous chapter.\n\n```{r}\nload(\"data/intermediate_data/chapter8.RData\")\n```\n\nWhen the experiment has RNA profiling (scRNA) and protein profiling (AbSeq) in single cell resolution, each measurement is one modality. The combined analysis of scRNA and AbSeq is so called \"multimodal analysis\".\n\nSeurat package also provides the framework to analyze multimodal data. The framework is the the weighted nearest neighbors (WNN) approach, which enables simultaneous clustering of cells based on weighted combination of both modalities.\n\n::: callout-note\nRNA profiling and protein profiling should be analyzed separately before combing for downstream analysis.\n:::\n\n# 1. Processing AbSeq\n\nWhen we analyzed the scRNAseq in the previous chapters, the dataset was filtered and only high quality cells are kept. AbSeq dataset is filtered to have the same cells.\n\n```{r}\n# get AbSeq from expMat\nab <- expMat$`Antibody Capture`\n\n# filter abseq data based on cell id from rna seurat object\nab <- ab[, colnames(integrate.filtered.rna)]\n```\n\nCreating a new Seurat object with AbSeq.\n\n```{r}\n# create a new assay to store AbSeq information\nab <- CreateAssayObject(counts = ab)\n\n# create a new Seurat object to store the combined analysis\ncombined <- integrate.filtered.rna\ncombined[[\"AB\"]] <- ab\n\n# Validate that the object now contains multiple assays\ncombined\n```\n\nNext, we normalize the AbSeq counts.\n\nThe recommended normalization method for AbSeq is CLR, Centered Log Ratio. Due to the unspecific binding background signal of antibody, log-normalization doesn't work well in AbSeq data.\n\nThere are 20 AbSeq in the experiment. We are going to use all of them as variable features.\n\n```{r}\n# switch the default assay to AbSeq\nDefaultAssay(combined) <- 'AB'\n\n# set variable features\nVariableFeatures(combined) <- rownames(combined[[\"AB\"]])\n\n# set a name for the dimentionality reduction to avoid overwriting\ncombined <- NormalizeData(combined, normalization.method = 'CLR', margin = 2) %>% \n  ScaleData() %>% \n  RunPCA(reduction.name = 'apca', approx = F)\n```\n\n# 2. Weighted nearest neighbour (WNN)\n\nThe weighted nearest neighbor (WNN) is a statistical framework implemented in Seurat for the multimodal analysis. WNN requires pre-processing and dimentionality reduction on both assays independently upfront.\n\n```{r}\ncombined <- FindMultiModalNeighbors(combined, \n                                    reduction.list = list(\"pca\", \"apca\"), \n                                    dims.list = list(1:15, 1:18), \n                                    modality.weight.name = \"RNA.weight\")\n```\n\n-   `reduction.list` Dimentionality reduction to use from each element\n\n-   `dims.list` Number of PCs to include from each element\n\n-   `modality.weight.name` Give a name to the weight of each element\n\nNow, we run UMAP using the calculated WNN.\n\nFor each cell, we calculate its closest neighbors in the dataset based on a weighted combination of RNA and protein similarities. We specify the dimensionality of each modality (similar to specifying the number of PCs to include in scRNA-seq clustering). We use the same number of PCs as we did in previous steps.\n\n```{r}\n# run UMAP\ncombined <- RunUMAP(combined, \n                    nn.name = \"weighted.nn\", \n                    reduction.name = \"wnn.umap\", \n                    reduction.key = \"wnnUMAP_\")\n\n# find clusters\ncombined <- FindClusters(combined, \n                         graph.name = \"wsnn\", \n                         resolution = 0.4, \n                         verbose = FALSE)\n```\n\nLook at the results in UMAP.\n\n```{r}\n# visualize the result in UMAP\np1 <- DimPlot(combined, reduction = 'wnn.umap', \n              label = TRUE, repel = TRUE, label.size = 2.5, \n              group.by = \"predicted.celltype.l1\")\n\np2 <- DimPlot(combined, reduction = 'wnn.umap', \n              label = TRUE, repel = TRUE, label.size = 2.5)\n\np1|p2\n```\n\nLet's compare the UMAPs from RNA only and from WNN. The T cells cluster better in WNN UMAP. Because AbSeq is often handpicked and cell type specific, bringing AbSeq in can have a better resolution.\n\n```{r}\n# compare the UMAPs based on RNA and on WNN\np1 <- DimPlot(combined, reduction = 'umap', group.by = 'predicted.celltype.l1', \n              label = TRUE, repel = TRUE, label.size = 2.5) + \n  NoLegend() + ggtitle(\"RNA\")\n\np2 <- DimPlot(combined, reduction = 'wnn.umap', group.by = 'predicted.celltype.l1', \n              label = TRUE, repel = TRUE, label.size = 2.5) + \n  NoLegend() + ggtitle(\"WNN\")\n\np1|p2\n```\n\n# 3. AbSeq visualization\n\nWe have several assays stored in the Seurat object. We can easily switch between them and work on different assays.\n\n::: callout-important\nIt is important to know which assay you are working on. We may get unexpected results if working on the wrong assay.\n:::\n\nLet's look at the protein and gene expression side by side. By setting the default assay, we can visualize one or the other.\n\nCD19 is a B cell marker. We can plot the UMAP with annotation side by side with the CD19 AbSeq.\n\n```{r}\n# switch default assay to AbSeq to plot protein expression\nDefaultAssay(combined) <- \"AB\"\np1 <- FeaturePlot(combined, \"CD19-CD19-AHS0030-pAbO\", \n                  cols = c(\"lightgrey\", \"darkgreen\"), \n                  reduction = 'wnn.umap')\n\n# switch default to RNA to plot gene expression\nDefaultAssay(combined) <- \"RNA\"\np2 <- FeaturePlot(combined, \"CD19\", reduction = 'wnn.umap')\n\n# place plots side-by-side\np1 | p2\n```\n\n# 4. Save\n\nSave the files into RData for documentation.\n\n```{r}\n# save(combined, expMat, ab, integrate.filtered.rna, file = \"data/intermediate_data/chapter9.RData\")\n```\n","srcMarkdownNoYaml":"\n\n```{r}\n# libraries for this chapter\nlibrary(tidyverse)\nlibrary(Seurat)\nlibrary(data.table)\nlibrary(celldex)\nlibrary(SingleR)\nlibrary(ExperimentHub)\n```\n\n# Load RData\n\nLoad the RData which contains all files from the previous chapter.\n\n```{r}\nload(\"data/intermediate_data/chapter8.RData\")\n```\n\nWhen the experiment has RNA profiling (scRNA) and protein profiling (AbSeq) in single cell resolution, each measurement is one modality. The combined analysis of scRNA and AbSeq is so called \"multimodal analysis\".\n\nSeurat package also provides the framework to analyze multimodal data. The framework is the the weighted nearest neighbors (WNN) approach, which enables simultaneous clustering of cells based on weighted combination of both modalities.\n\n::: callout-note\nRNA profiling and protein profiling should be analyzed separately before combing for downstream analysis.\n:::\n\n# 1. Processing AbSeq\n\nWhen we analyzed the scRNAseq in the previous chapters, the dataset was filtered and only high quality cells are kept. AbSeq dataset is filtered to have the same cells.\n\n```{r}\n# get AbSeq from expMat\nab <- expMat$`Antibody Capture`\n\n# filter abseq data based on cell id from rna seurat object\nab <- ab[, colnames(integrate.filtered.rna)]\n```\n\nCreating a new Seurat object with AbSeq.\n\n```{r}\n# create a new assay to store AbSeq information\nab <- CreateAssayObject(counts = ab)\n\n# create a new Seurat object to store the combined analysis\ncombined <- integrate.filtered.rna\ncombined[[\"AB\"]] <- ab\n\n# Validate that the object now contains multiple assays\ncombined\n```\n\nNext, we normalize the AbSeq counts.\n\nThe recommended normalization method for AbSeq is CLR, Centered Log Ratio. Due to the unspecific binding background signal of antibody, log-normalization doesn't work well in AbSeq data.\n\nThere are 20 AbSeq in the experiment. We are going to use all of them as variable features.\n\n```{r}\n# switch the default assay to AbSeq\nDefaultAssay(combined) <- 'AB'\n\n# set variable features\nVariableFeatures(combined) <- rownames(combined[[\"AB\"]])\n\n# set a name for the dimentionality reduction to avoid overwriting\ncombined <- NormalizeData(combined, normalization.method = 'CLR', margin = 2) %>% \n  ScaleData() %>% \n  RunPCA(reduction.name = 'apca', approx = F)\n```\n\n# 2. Weighted nearest neighbour (WNN)\n\nThe weighted nearest neighbor (WNN) is a statistical framework implemented in Seurat for the multimodal analysis. WNN requires pre-processing and dimentionality reduction on both assays independently upfront.\n\n```{r}\ncombined <- FindMultiModalNeighbors(combined, \n                                    reduction.list = list(\"pca\", \"apca\"), \n                                    dims.list = list(1:15, 1:18), \n                                    modality.weight.name = \"RNA.weight\")\n```\n\n-   `reduction.list` Dimentionality reduction to use from each element\n\n-   `dims.list` Number of PCs to include from each element\n\n-   `modality.weight.name` Give a name to the weight of each element\n\nNow, we run UMAP using the calculated WNN.\n\nFor each cell, we calculate its closest neighbors in the dataset based on a weighted combination of RNA and protein similarities. We specify the dimensionality of each modality (similar to specifying the number of PCs to include in scRNA-seq clustering). We use the same number of PCs as we did in previous steps.\n\n```{r}\n# run UMAP\ncombined <- RunUMAP(combined, \n                    nn.name = \"weighted.nn\", \n                    reduction.name = \"wnn.umap\", \n                    reduction.key = \"wnnUMAP_\")\n\n# find clusters\ncombined <- FindClusters(combined, \n                         graph.name = \"wsnn\", \n                         resolution = 0.4, \n                         verbose = FALSE)\n```\n\nLook at the results in UMAP.\n\n```{r}\n# visualize the result in UMAP\np1 <- DimPlot(combined, reduction = 'wnn.umap', \n              label = TRUE, repel = TRUE, label.size = 2.5, \n              group.by = \"predicted.celltype.l1\")\n\np2 <- DimPlot(combined, reduction = 'wnn.umap', \n              label = TRUE, repel = TRUE, label.size = 2.5)\n\np1|p2\n```\n\nLet's compare the UMAPs from RNA only and from WNN. The T cells cluster better in WNN UMAP. Because AbSeq is often handpicked and cell type specific, bringing AbSeq in can have a better resolution.\n\n```{r}\n# compare the UMAPs based on RNA and on WNN\np1 <- DimPlot(combined, reduction = 'umap', group.by = 'predicted.celltype.l1', \n              label = TRUE, repel = TRUE, label.size = 2.5) + \n  NoLegend() + ggtitle(\"RNA\")\n\np2 <- DimPlot(combined, reduction = 'wnn.umap', group.by = 'predicted.celltype.l1', \n              label = TRUE, repel = TRUE, label.size = 2.5) + \n  NoLegend() + ggtitle(\"WNN\")\n\np1|p2\n```\n\n# 3. AbSeq visualization\n\nWe have several assays stored in the Seurat object. We can easily switch between them and work on different assays.\n\n::: callout-important\nIt is important to know which assay you are working on. We may get unexpected results if working on the wrong assay.\n:::\n\nLet's look at the protein and gene expression side by side. By setting the default assay, we can visualize one or the other.\n\nCD19 is a B cell marker. We can plot the UMAP with annotation side by side with the CD19 AbSeq.\n\n```{r}\n# switch default assay to AbSeq to plot protein expression\nDefaultAssay(combined) <- \"AB\"\np1 <- FeaturePlot(combined, \"CD19-CD19-AHS0030-pAbO\", \n                  cols = c(\"lightgrey\", \"darkgreen\"), \n                  reduction = 'wnn.umap')\n\n# switch default to RNA to plot gene expression\nDefaultAssay(combined) <- \"RNA\"\np2 <- FeaturePlot(combined, \"CD19\", reduction = 'wnn.umap')\n\n# place plots side-by-side\np1 | p2\n```\n\n# 4. Save\n\nSave the files into RData for documentation.\n\n```{r}\n# save(combined, expMat, ab, integrate.filtered.rna, file = \"data/intermediate_data/chapter9.RData\")\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":true,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"tidy":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"09_combining.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.340","theme":"cosmo","title":"Chapter 9 Combine scRNAseq and AbSeq"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}